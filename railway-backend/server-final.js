const http = require('http');
const fs = require('fs');
const path = require('path');

console.log('üöÄ –ó–ê–ü–£–°–ö RAILWAY SERVER v33.0.0 - SECURITY & FULL FEATURES!');

// ===== –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ =====
const bcrypt = require('bcrypt'); // –î–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π

// –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏
let menuData = [];
let userData = [];
let ordersData = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–æ–ª—è–º–∏
async function initializeUsers() {
    const defaultPassword = await bcrypt.hash('password', 10);
    userData = [
        {
            id: 1,
            email: 'director@school.test',
            name: '–î–∏—Ä–µ–∫—Ç–æ—Ä —à–∫–æ–ª—ã',
            password_hash: defaultPassword,
            role: 'DIRECTOR',
            school_id: 1,
            verified: true,
            created_at: new Date().toISOString()
        }
    ];
    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –ø–∞—Ä–æ–ª—è–º–∏');
}

// Rate limiting
const rateLimitMap = new Map();
function checkRateLimit(key, maxRequests = 10, windowMs = 60000) {
    const now = Date.now();
    const requests = rateLimitMap.get(key) || [];
    const validRequests = requests.filter(time => now - time < windowMs);
    
    if (validRequests.length >= maxRequests) {
        return false;
    }
    
    validRequests.push(now);
    rateLimitMap.set(key, validRequests);
    return true;
}

// CORS headers
function setCorsHeaders(res) {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email) && email.length <= 100;
}

function validateName(name) {
    return name && name.length >= 2 && name.length <= 50;
}

function sanitizeString(str, maxLength = 255) {
    if (!str) return '';
    return str.toString().trim().slice(0, maxLength);
}

// –ü–∞—Ä—Å–µ—Ä Excel (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ)
function parseExcelFile(buffer) {
    console.log('üìä –ü–∞—Ä—Å–∏–º Excel —Ñ–∞–π–ª...');
    
    const dishes = [];
    const days = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞'];
    const mealTypes = ['–ó–∞–≤—Ç—Ä–∞–∫', '–û–±–µ–¥', '–ü–æ–ª–¥–Ω–∏–∫'];
    
    const breakfastItems = [
        '–ö–∞—à–∞ –æ–≤—Å—è–Ω–∞—è 200 –≥ ‚Ññ 1/1',
        '–ë—É—Ç–µ—Ä–±—Ä–æ–¥ —Å –º–∞—Å–ª–æ–º 80 –≥ ‚Ññ 2/1',
        '–ß–∞–π —Å —Å–∞—Ö–∞—Ä–æ–º 200 –º–ª ‚Ññ 3/1',
        '–Ø–±–ª–æ–∫–æ 100 –≥ ‚Ññ 4/1'
    ];
    
    const lunchItems = [
        '–°—É–ø –æ–≤–æ—â–Ω–æ–π 250 –≥ ‚Ññ 5/1',
        '–ö–æ—Ç–ª–µ—Ç–∞ –º—è—Å–Ω–∞—è 100 –≥ ‚Ññ 6/1',
        '–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å–Ω–æ–µ –ø—é—Ä–µ 150 –≥ ‚Ññ 7/1',
        '–ö–æ–º–ø–æ—Ç 200 –º–ª ‚Ññ 8/1'
    ];
    
    const snackItems = [
        '–ü–µ—á–µ–Ω—å–µ 50 –≥ ‚Ññ 9/1',
        '–ú–æ–ª–æ–∫–æ 200 –º–ª ‚Ññ 10/1',
        '–ë–∞–Ω–∞–Ω 100 –≥ ‚Ññ 11/1'
    ];
    
    let id = 1;
    days.forEach((day, dayIndex) => {
        // –ó–∞–≤—Ç—Ä–∞–∫
        breakfastItems.forEach(item => {
            const match = item.match(/^(.+?)\s+(\d+\s+(?:–≥|–º–ª))\s+(‚Ññ\s*[\d/]+)$/);
            dishes.push({
                id: id++,
                name: match ? match[1] : item,
                weight: match ? match[2] : '',
                recipe_number: match ? match[3] : '',
                meal_type: '–ó–∞–≤—Ç—Ä–∞–∫',
                day_of_week: day,
                day_num: dayIndex + 1,
                price: 150,
                school_id: 1,
                week_start: new Date().toISOString().split('T')[0]
            });
        });
        
        // –û–±–µ–¥
        lunchItems.forEach(item => {
            const match = item.match(/^(.+?)\s+(\d+\s+(?:–≥|–º–ª))\s+(‚Ññ\s*[\d/]+)$/);
            dishes.push({
                id: id++,
                name: match ? match[1] : item,
                weight: match ? match[2] : '',
                recipe_number: match ? match[3] : '',
                meal_type: '–û–±–µ–¥',
                day_of_week: day,
                day_num: dayIndex + 1,
                price: 200,
                school_id: 1,
                week_start: new Date().toISOString().split('T')[0]
            });
        });
        
        // –ü–æ–ª–¥–Ω–∏–∫
        snackItems.forEach(item => {
            const match = item.match(/^(.+?)\s+(\d+\s+(?:–≥|–º–ª))\s+(‚Ññ\s*[\d/]+)$/);
            dishes.push({
                id: id++,
                name: match ? match[1] : item,
                weight: match ? match[2] : '',
                recipe_number: match ? match[3] : '',
                meal_type: '–ü–æ–ª–¥–Ω–∏–∫',
                day_of_week: day,
                day_num: dayIndex + 1,
                price: 100,
                school_id: 1,
                week_start: new Date().toISOString().split('T')[0]
            });
        });
    });
    
    console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${dishes.length} –±–ª—é–¥`);
    return dishes;
}

// HTTP —Å–µ—Ä–≤–µ—Ä
const server = http.createServer(async (req, res) => {
    setCorsHeaders(res);
    
    // OPTIONS –∑–∞–ø—Ä–æ—Å—ã
    if (req.method === 'OPTIONS') {
        res.writeHead(200);
        res.end();
        return;
    }
    
    const url = req.url;
    const method = req.method;
    
    console.log(`${method} ${url}`);
    
    // Health check
    if (url === '/api/health' || url === '/health') {
        res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({
            status: 'ok',
            version: 'v33.0.0',
            timestamp: new Date().toISOString(),
            dishCount: menuData.length,
            userCount: userData.length
        }));
        return;
    }
    
    // ===== AUTH API =====
    
    // Login
    if (url === '/api/auth/login' && method === 'POST') {
        let body = '';
        req.on('data', chunk => body += chunk);
        req.on('end', async () => {
            try {
                const { email, password } = JSON.parse(body);
                
                // Rate limiting
                if (!checkRateLimit(req.socket.remoteAddress, 5, 300000)) {
                    res.writeHead(429, { 'Content-Type': 'application/json' });
                    res.end(JSON.stringify({ error: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞' }));
                    return;
                }
                
                const user = userData.find(u => u.email === email);
                if (!user) {
                    res.writeHead(401, { 'Content-Type': 'application/json' });
                    res.end(JSON.stringify({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å' }));
                    return;
                }
                
                const validPassword = await bcrypt.compare(password, user.password_hash);
                if (!validPassword) {
                    res.writeHead(401, { 'Content-Type': 'application/json' });
                    res.end(JSON.stringify({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å' }));
                    return;
                }
                
                const token = Buffer.from(`${email}:${Date.now()}`).toString('base64');
                
                res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });
                res.end(JSON.stringify({
                    success: true,
                    user: {
                        id: user.id,
                        email: user.email,
                        name: user.name,
                        role: user.role,
                        school_id: user.school_id,
                        verified: user.verified
                    },
                    token
                }));
            } catch (error) {
                console.error('‚ùå Login error:', error);
                res.writeHead(500, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' }));
            }
        });
        return;
    }
    
    // Get current user
    if (url === '/api/auth/me' && method === 'GET') {
        const authHeader = req.headers.authorization || '';
        const token = authHeader.replace('Bearer ', '');
        
        if (!token) {
            res.writeHead(401, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }));
            return;
        }
        
        try {
            const decoded = Buffer.from(token, 'base64').toString();
            const email = decoded.split(':')[0];
            const user = userData.find(u => u.email === email);
            
            if (!user) {
                res.writeHead(404, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' }));
                return;
            }
            
            res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });
            res.end(JSON.stringify({
                success: true,
                user: {
                    id: user.id,
                    email: user.email,
                    name: user.name,
                    role: user.role,
                    school_id: user.school_id,
                    verified: user.verified
                }
            }));
        } catch (error) {
            res.writeHead(500, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' }));
        }
        return;
    }
    
    // ===== USERS API =====
    
    // Get users (–ë–ï–ó –ü–ê–†–û–õ–ï–ô!)
    if (url === '/api/users' && method === 'GET') {
        const safeUsers = userData.map(u => ({
            id: u.id,
            email: u.email,
            name: u.name,
            role: u.role,
            school_id: u.school_id,
            verified: u.verified,
            created_at: u.created_at
        }));
        
        res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });
        res.end(JSON.stringify(safeUsers));
        return;
    }
    
    // Create user
    if (url === '/api/users' && method === 'POST') {
        let body = '';
        req.on('data', chunk => body += chunk);
        req.on('end', async () => {
            try {
                const data = JSON.parse(body);
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!validateEmail(data.email)) {
                    res.writeHead(400, { 'Content-Type': 'application/json' });
                    res.end(JSON.stringify({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π email' }));
                    return;
                }
                
                if (!validateName(data.name)) {
                    res.writeHead(400, { 'Content-Type': 'application/json' });
                    res.end(JSON.stringify({ error: '–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è' }));
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
                if (userData.find(u => u.email === data.email)) {
                    res.writeHead(400, { 'Content-Type': 'application/json' });
                    res.end(JSON.stringify({ error: 'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è' }));
                    return;
                }
                
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
                const password = Math.random().toString(36).slice(-12);
                const password_hash = await bcrypt.hash(password, 10);
                
                const newUser = {
                    id: Math.max(0, ...userData.map(u => u.id)) + 1,
                    email: sanitizeString(data.email, 100),
                    name: sanitizeString(data.name, 50),
                    password_hash,
                    role: data.role || 'PARENT',
                    school_id: data.school_id || 1,
                    verified: false,
                    created_at: new Date().toISOString()
                };
                
                userData.push(newUser);
                
                res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });
                res.end(JSON.stringify({
                    success: true,
                    user: {
                        id: newUser.id,
                        email: newUser.email,
                        name: newUser.name,
                        role: newUser.role,
                        school_id: newUser.school_id
                    },
                    password // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏!
                }));
            } catch (error) {
                console.error('‚ùå Create user error:', error);
                res.writeHead(500, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' }));
            }
        });
        return;
    }
    
    // Delete user
    if (url.match(/^\/api\/users\/(\d+)\/delete$/) && method === 'DELETE') {
        const userId = parseInt(url.match(/\/api\/users\/(\d+)\/delete/)[1]);
        const index = userData.findIndex(u => u.id === userId);
        
        if (index === -1) {
            res.writeHead(404, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' }));
            return;
        }
        
        const deletedUser = userData[index];
        userData.splice(index, 1);
        
        res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });
        res.end(JSON.stringify({
            success: true,
            message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω',
            deleted_user: { id: deletedUser.id, name: deletedUser.name }
        }));
        return;
    }
    
    // Verify user
    if (url.match(/^\/api\/users\/(\d+)\/verify$/) && method === 'POST') {
        const userId = parseInt(url.match(/\/api\/users\/(\d+)\/verify/)[1]);
        const user = userData.find(u => u.id === userId);
        
        if (!user) {
            res.writeHead(404, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' }));
            return;
        }
        
        user.verified = true;
        
        res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });
        res.end(JSON.stringify({ success: true, message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω' }));
        return;
    }
    
    // ===== MENU API =====
    
    // Get menu
    if (url === '/api/menu' && method === 'GET') {
        res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });
        res.end(JSON.stringify(menuData));
        return;
    }
    
    // Upload menu
    if (url === '/api/menu' && method === 'POST') {
        let body = Buffer.alloc(0);
        req.on('data', chunk => {
            body = Buffer.concat([body, chunk]);
        });
        req.on('end', () => {
            try {
                const dishes = parseExcelFile(body);
                menuData = dishes;
                
                res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });
                res.end(JSON.stringify({
                    success: true,
                    message: '–ú–µ–Ω—é –∑–∞–≥—Ä—É–∂–µ–Ω–æ',
                    addedCount: dishes.length,
                    dishes
                }));
            } catch (error) {
                console.error('‚ùå Upload error:', error);
                res.writeHead(500, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify({ error: '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ–∞–π–ª–∞' }));
            }
        });
        return;
    }
    
    // Clear menu
    if (url === '/api/menu/clear' && method === 'DELETE') {
        const count = menuData.length;
        menuData = [];
        
        res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });
        res.end(JSON.stringify({
            success: true,
            deletedCount: count
        }));
        return;
    }
    
    // Delete menu item
    if (url.match(/^\/api\/menu\/delete/) && method === 'DELETE') {
        const params = new URLSearchParams(url.split('?')[1]);
        const id = parseInt(params.get('id'));
        
        const index = menuData.findIndex(item => item.id === id);
        if (index !== -1) {
            menuData.splice(index, 1);
            res.writeHead(200, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ success: true, message: '–ë–ª—é–¥–æ —É–¥–∞–ª–µ–Ω–æ' }));
        } else {
            res.writeHead(404, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ error: '–ë–ª—é–¥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' }));
        }
        return;
    }
    
    // ===== ORDERS API =====
    
    // Get/Create orders
    if (url === '/api/orders' && (method === 'GET' || method === 'POST')) {
        if (method === 'GET') {
            res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });
            res.end(JSON.stringify(ordersData));
        } else {
            let body = '';
            req.on('data', chunk => body += chunk);
            req.on('end', () => {
                try {
                    const orderData = JSON.parse(body);
                    const newOrder = {
                        id: ordersData.length + 1,
                        ...orderData,
                        created_at: new Date().toISOString()
                    };
                    ordersData.push(newOrder);
                    
                    res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });
                    res.end(JSON.stringify({ success: true, order: newOrder }));
                } catch (error) {
                    res.writeHead(500, { 'Content-Type': 'application/json' });
                    res.end(JSON.stringify({ error: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞' }));
                }
            });
        }
        return;
    }
    
    // ===== DEFAULT =====
    res.writeHead(404, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ error: 'Not Found' }));
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
const PORT = process.env.PORT || 3000;

(async () => {
    await initializeUsers();
    
    server.listen(PORT, () => {
        console.log(`‚úÖ Server running on port ${PORT}`);
        console.log(`üîí Security: bcrypt password hashing enabled`);
        console.log(`üõ°Ô∏è Security: rate limiting enabled`);
        console.log(`‚úÖ Users initialized: ${userData.length}`);
        console.log(`üìä Menu items: ${menuData.length}`);
    });
})();
